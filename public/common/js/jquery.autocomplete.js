(function(A){A.Autocompleter=function(C,D){this.cacheData_={};this.cacheLength_=0;this.selectClass_="jquery-autocomplete-selected-item";this.keyTimeout_=null;this.lastKeyPressed_=null;this.lastProcessedValue_=null;this.lastSelectedValue_=null;this.active_=false;this.finishOnBlur_=true;if(!C||!(C instanceof jQuery)||C.length!==1||C.get(0).tagName.toUpperCase()!=="INPUT"){alert("Invalid parameter for jquery.Autocompleter, jQuery object with one element with INPUT tag expected");return }if(typeof D==="string"){this.options={url:D}}else{this.options=D}this.options.maxCacheLength=parseInt(this.options.maxCacheLength,10);if(isNaN(this.options.maxCacheLength)||this.options.maxCacheLength<1){this.options.maxCacheLength=1}this.options.minChars=parseInt(this.options.minChars,10);if(isNaN(this.options.minChars)||this.options.minChars<1){this.options.minChars=1}this.dom={};this.dom.$elem=C;if(this.options.inputClass){this.dom.$elem.addClass(this.options.inputClass)}this.dom.$results=A("<div></div>").hide();if(this.options.resultsClass){this.dom.$results.addClass(this.options.resultsClass)}this.dom.$results.css({position:"absolute"});A("body").append(this.dom.$results);var B=this;C.keyup(function(E){B.lastKeyPressed_=E.keyCode;switch(B.lastKeyPressed_){case 38:E.preventDefault();if(B.active_){B.focusPrev()}else{B.activate()}return false;break;case 40:E.preventDefault();if(B.active_){B.focusNext()}else{B.activate()}return false;break;case 9:case 13:if(B.active_){E.preventDefault();B.selectCurrent();return false}break;case 27:if(B.active_){E.preventDefault();B.finish();return false}break;default:B.activate()}});C.blur(function(){if(B.finishOnBlur_){setTimeout(function(){B.finish()},200)}})};A.Autocompleter.prototype.position=function(){var B=this.dom.$elem.offset();this.dom.$results.css({top:B.top+this.dom.$elem.outerHeight(),left:B.left})};A.Autocompleter.prototype.cacheRead=function(E){var G,D,C,B,F;if(this.options.useCache){E=String(E);G=E.length;if(this.options.matchSubset){D=1}else{D=G}while(D<=G){if(this.options.matchInside){B=G-D}else{B=0}F=0;while(F<=B){C=E.substr(0,D);if(this.cacheData_[C]!==undefined){return this.cacheData_[C]}F++}D++}}return false};A.Autocompleter.prototype.cacheWrite=function(B,C){if(this.options.useCache){if(this.cacheLength_>=this.options.maxCacheLength){this.cacheFlush()}B=String(B);if(this.cacheData_[B]!==undefined){this.cacheLength_++}return this.cacheData_[B]=C}return false};A.Autocompleter.prototype.cacheFlush=function(){this.cacheData_={};this.cacheLength_=0};A.Autocompleter.prototype.callHook=function(D,C){var B=this.options[D];if(B&&A.isFunction(B)){return B(C,this)}return false};A.Autocompleter.prototype.activate=function(){var C=this;var B=function(){C.activateNow()};var D=parseInt(this.options.delay,10);if(isNaN(D)||D<=0){D=250}if(this.keyTimeout_){clearTimeout(this.keyTimeout_)}this.keyTimeout_=setTimeout(B,D)};A.Autocompleter.prototype.activateNow=function(){var B=this.dom.$elem.val();if(B!==this.lastProcessedValue_&&B!==this.lastSelectedValue_){if(B.length>=this.options.minChars){this.active_=true;this.lastProcessedValue_=B;this.fetchData(B)}}};A.Autocompleter.prototype.fetchData=function(C){if(this.options.data){this.filterAndShowResults(this.options.data,C)}else{var B=this;this.fetchRemoteData(C,function(D){B.filterAndShowResults(D,C)})}};A.Autocompleter.prototype.fetchRemoteData=function(D,F){if(refee){Fandian_DelCookie("coord_name");Fandian_DelCookie("coord_guid");Fandian_DelCookie("longitude");Fandian_DelCookie("latitude");refee=false}var E=this.cacheRead(D);if(E){F(E)}else{var B=this;this.dom.$elem.addClass(this.options.loadingClass);var C=function(H){var G=false;if(H!==false){G=B.parseRemoteData(H);B.cacheWrite(D,G)}B.dom.$elem.removeClass(B.options.loadingClass);F(G)};A.ajax({url:this.makeUrl(D),success:C,error:function(){C(false)}})}};A.Autocompleter.prototype.setExtraParam=function(C,D){var B=A.trim(String(C));if(B){if(!this.options.extraParams){this.options.extraParams={}}if(this.options.extraParams[B]!==D){this.options.extraParams[B]=D;this.cacheFlush()}}};A.Autocompleter.prototype.makeUrl=function(G){var B=this;var E=this.options.paramName||"q";var C=this.options.url;var F=A.extend({},this.options.extraParams);if(this.options.paramName===false){C+=encodeURIComponent(G)}else{F[E]=G}var D=[];A.each(F,function(H,I){D.push(B.makeUrlParam(H,I))});if(D.length){C+=C.indexOf("?")==-1?"?":"&";C+=D.join("&")}return C};A.Autocompleter.prototype.makeUrlParam=function(B,C){return String(B)+"="+encodeURIComponent(C)};A.Autocompleter.prototype.parseRemoteData=function(F){var D=[];var H=String(F).replace("\r\n","\n");var E,B,C,I,J=H.split("\n");var G;for(E=0;E<J.length;E++){I=J[E].split("|");C=[];for(B=0;B<I.length;B++){C.push(unescape(I[B]))}G=C.shift();D.push({value:unescape(G),data:C})}return D};A.Autocompleter.prototype.filterAndShowResults=function(B,C){this.showResults(this.filterResults(B,C),C)};A.Autocompleter.prototype.filterResults=function(F,C){var H=[];var M,E,G,N,J,B;var L,I,D="";var K=new RegExp("[.*+?|()\\[\\]{}\\\\]","g");for(G=0;G<F.length;G++){N=F[G];J=typeof N;if(J==="string"){M=N;E={}}else{if(A.isArray(N)){M=N[0];E=N.slice(1)}else{if(J==="object"){M=N.value;E=N.data}}}M=String(M);if(M>""){if(typeof E!=="object"){E={}}B=!this.options.filterResults;if(!B){I=String(C);I=I.replace(K,"\\$&");if(!this.options.matchInside){I="^"+I}if(!this.options.matchCase){D="i"}L=new RegExp(I,D);B=L.test(M)}if(B){H.push({value:M,data:E})}}}if(this.options.sortResults){H=this.sortResults(H,C)}if(this.options.maxItemsToShow>0&&this.options.maxItemsToShow<H.length){H.length=this.options.maxItemsToShow}return H};A.Autocompleter.prototype.sortResults=function(D,E){var C=this;var B=this.options.sortFunction;if(!A.isFunction(B)){B=function(G,F,H){return C.sortValueAlpha(G,F,H)}}D.sort(function(G,F){return B(G,F,E)});return D};A.Autocompleter.prototype.sortValueAlpha=function(C,B,D){C=String(C.value);B=String(B.value);if(!this.options.matchCase){C=C.toLowerCase();B=B.toLowerCase()}if(C>B){return 1}if(C<B){return -1}return 0};A.Autocompleter.prototype.showResults=function(F,C){var K=this;var H=A("<ul></ul>");var G,L,J,B,I=false,E=false;var D=F.length;for(G=0;G<D;G++){L=F[G];J=A("<li>"+this.showResult(L.value,L.data)+"</li>");J.data("value",L.value);J.data("data",L.data);J.click(function(){var M=A(this);K.selectItem(M)}).mousedown(function(){K.finishOnBlur_=false}).mouseup(function(){K.finishOnBlur_=true});H.append(J);if(I===false){I=String(L.value);E=J;J.addClass(this.options.firstItemClass)}if(G==D-1){J.addClass(this.options.lastItemClass)}}this.position();if(D==0){this.dom.$results.html(H).hide();A("#hidden_id").val("0")}else{this.dom.$results.html(H).show()}B=this.dom.$results.outerWidth()-this.dom.$results.width();this.dom.$results.width(this.dom.$elem.outerWidth()-B);A("li",this.dom.$results).hover(function(){K.focusItem(this)},function(){});if(this.autoFill(I,C)){this.focusItem(E)}};A.Autocompleter.prototype.showResult=function(C,B){if(A.isFunction(this.options.showResult)){return this.options.showResult(C,B)}else{return C}};A.Autocompleter.prototype.autoFill=function(F,D){var C,B,E,G;if(this.options.autoFill&&this.lastKeyPressed_!=8){C=String(F).toLowerCase();B=String(D).toLowerCase();E=F.length;G=D.length;if(C.substr(0,G)===B){this.dom.$elem.val(F);this.selectRange(G,E);return true}}return false};A.Autocompleter.prototype.focusNext=function(){this.focusMove(+1)};A.Autocompleter.prototype.focusPrev=function(){this.focusMove(-1)};A.Autocompleter.prototype.focusMove=function(B){var C,D=A("li",this.dom.$results);B=parseInt(B,10);for(var C=0;C<D.length;C++){if(A(D[C]).hasClass(this.selectClass_)){this.focusItem(C+B);return }}this.focusItem(0)};A.Autocompleter.prototype.focusItem=function(C){var B,D=A("li",this.dom.$results);if(D.length){D.removeClass(this.selectClass_).removeClass(this.options.selectClass);if(typeof C==="number"){C=parseInt(C,10);if(C<0){C=0}else{if(C>=D.length){C=D.length-1}}B=A(D[C])}else{B=A(C)}if(B){B.addClass(this.selectClass_).addClass(this.options.selectClass)}}};A.Autocompleter.prototype.selectCurrent=function(){var B=A("li."+this.selectClass_,this.dom.$results);if(B.length==1){this.selectItem(B)}else{this.finish()}};A.Autocompleter.prototype.selectItem=function(E){var D=E.data("value");arr=new Array;arr=D.split("@");D=arr[0];var C=E.data("data");var B=this.displayValue(D,C);this.lastProcessedValue_=B;this.lastSelectedValue_=B;this.dom.$elem.val(B).focus();this.setCaret(B.length);this.callHook("onItemSelect",{value:D,data:C});this.finish()};A.Autocompleter.prototype.displayValue=function(C,B){if(A.isFunction(this.options.displayValue)){return this.options.displayValue(C,B)}else{return C}};A.Autocompleter.prototype.finish=function(){if(this.keyTimeout_){clearTimeout(this.keyTimeout_)}if(this.dom.$elem.val()!==this.lastSelectedValue_){if(this.options.mustMatch){this.dom.$elem.val("")}this.callHook("onNoMatch")}this.dom.$results.hide();this.lastKeyPressed_=null;this.lastProcessedValue_=null;if(this.active_){this.callHook("onFinish")}this.active_=false};A.Autocompleter.prototype.selectRange=function(E,B){var D=this.dom.$elem.get(0);if(D.setSelectionRange){D.focus();D.setSelectionRange(E,B)}else{if(this.createTextRange){var C=this.createTextRange();C.collapse(true);C.moveEnd("character",B);C.moveStart("character",E);C.select()}}};A.Autocompleter.prototype.setCaret=function(B){this.selectRange(B,B)};A.fn.autocomplete=function(B){if(typeof B==="string"){B={url:B}}var C=A.extend({},A.fn.autocomplete.defaults,B);return this.each(function(){var E=A(this);var D=new A.Autocompleter(E,C);E.data("autocompleter",D)})};A.fn.autocomplete.defaults={paramName:"q",minChars:2,loadingClass:"acLoading",resultsClass:"acResults",inputClass:"acInput",selectClass:"acSelect",mustMatch:false,matchCase:false,matchInside:true,matchSubset:true,useCache:true,maxCacheLength:10,autoFill:false,filterResults:true,sortResults:true,sortFunction:false,onItemSelect:false,onNoMatch:false,maxItemsToShow:10}})(jQuery);